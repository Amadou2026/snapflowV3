{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="{% static 'js/dashboard-charts.js' %}"></script>

<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/custom_admin.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-header">
    <h1 class="dashboard-title">üìä Monitoring des Tests</h1>

    <form method="get" id="dashboard-form" class="dashboard-form">
      <label for="projet">Tous les projets :</label>
      <select name="projet_id" id="projet" onchange="this.form.submit();">
        <option value="" {% if not selected_projet_id %}selected{% endif %}>-- Tous les projets --</option>
        {% for projet in projets %}
        <option value="{{ projet.id }}" {% if projet.id|stringformat:"s" == selected_projet_id %}selected{% endif %}>
          {{ projet.nom }}
        </option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- KPI Grid responsive -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="chart-header">
        <span class="chart-icon">üß©</span>
        <h3 class="chart-title">R√©partition par projet</h3>
      </div>
      <div class="chart-container pie">
        <canvas id="projetChart"></canvas>
      </div>
    </div>

<div class="kpi-card">
  <div class="kpi-header-modern">
    <div class="kpi-icon-modern-nbr-test"></div>
     <h3 class="chart-title"> Nombre total des tests</h3>
  </div>
  <div class="kpi-divider-nbr-test"></div>
  <div id="kpi-taux-total-tests" class="kpi-value" data-total="{{ total_tests }}">
    <a id="total-tests-link" href="#">0</a> tests
  </div>
  <div class="kpi-label">Total des tests</div>
</div>

    <!-- KPI Taux de R√©ussite -->
    <div class="kpi-card">
      <div class="kpi-header-modern">
        <div class="kpi-icon-modern-percent-test"></div>
        <h3 class="chart-title"> Pourcentage des tests</h3>        
        <span id="status-indicator" class="status-indicator"></span>

      </div>
      <div class="kpi-divider-percent-test"></div>
      <div id="kpi-taux-reussite" class="kpi-value">0%</div>
      <div id="kpi-detail-tests" class="kpi-detail">
        <a id="kpi-succes-link" href="#"><b>0</b></a> succ√®s / <span id="total-tests-succes">0</span> tests
      </div>
      <div class="kpi-label">Taux de r√©ussite global</div>
      <br>
      <div id="kpi-taux-echec" class="kpi-value">0%</div>
      <div id="kpi-detail-echec" class="kpi-detail">
        <a href="#" id="kpi-echec-link"><b>0</b></a> √©checs / <span id="total-tests-echec">0</span> tests
      </div>
      <div class="kpi-label">Taux d'√©checs global</div>
    </div>



    <!-- Bloc Alertes -->
    <div class="kpi-card-modern">
      <div class="kpi-header-modern">
        <div class="kpi-icon-modern warning"></div>
        <div class="kpi-title">Les Tests √©chou√©s</div>
      </div>
      <div class="kpi-section">
      </div>
      <div class="kpi-divider"></div>
      <div class="kpi-section">
        <a href="/admin/core/executiontest/?statut__exact=error" class="kpi-number clickable">
          <strong id="tests-en-echec-value">--</strong>
          <span class="kpi-percent" id="percent-tests-echec"> tests √©chou√©s</span>          
        </a>        
      </div>
    </div>
  </div>

  <!-- Graphique √©volution -->
  <div class="chart-card withfull mt-5">
    <div class="chart-header">
      <span class="chart-icon">‚öñÔ∏è</span>
      <h3 class="chart-title">√âvolution des tests par jour</h3>
    </div>
    <div class="chart-container">
      <canvas id="sfChart"></canvas>
    </div>
  </div>

  <!-- Graphique projets avec erreurs -->
  <div class="chart-card margin-top-large">
    <div class="chart-header">
      <span class="chart-icon">‚ö†Ô∏è</span>
      <h3 class="chart-title">Projet avec le plus et le moins d'erreurs</h3>
    </div>

    <div class="filters-container">
      <div class="filters-row">
        <div class="filter-group">
          <label for="periodeSelect">Filtrer par :</label>
          <select id="periodeSelect">
            <option value="jour">Dernier jour</option>
            <option value="semaine">Derni√®re semaine</option>
            <option value="mois" selected>Dernier mois</option>
            <option value="annee">Derni√®re ann√©e</option>
          </select>
        </div>
      </div>
      <div id="periodeIndicator" class="periode-indicator"></div>
    </div>

    <div class="chart-container" style="position: relative;">
      <canvas id="projetErreurChart" width="600" height="300"></canvas>
      <div id="chartLoader" class="chart-loader">
        <div class="spinner"></div>
        <p>Chargement...</p>
      </div>
    </div>
  </div>
</div>
<!-- .dashboard-container -->

<!-- JS Data -->
<script>
  window.dashboardData = {
    labels: {{ labels | safe }},
  values: { { values | safe } },
  sf_labels: { { sf_labels | safe } },
  sf_success: { { sf_success | safe } },
  sf_fail: { { sf_fail | safe } },
  projet_labels: { { projet_labels | safe } },
  projet_counts: { { projet_counts | safe } },
  erreurs_labels: { { erreurs_labels | safe } },
  erreurs_counts: { { erreurs_counts | safe } }
  };
</script>

<!-- Script pour initialiser les graphiques + injecter les KPI scripts/tests -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Initialiser les graphiques
  initCharts(window.dashboardData);

  // R√©cup√©rer le projet s√©lectionn√© depuis l'URL
  const urlParams = new URLSearchParams(window.location.search);
  const projetId = urlParams.get('projet_id');
  const queryParam = projetId ? `?projet_id=${projetId}` : '';

  // Fetch des KPIs scripts/tests filtr√©s par projet
  fetch(`/api/stats/scripts-tests/${queryParam}`)
    .then(response => response.json())
    .then(data => {
      // Tests en √©chec
      const testsEchecDiv = document.getElementById('tests-en-echec-value');
      const percentEchecDiv = document.getElementById('percent-tests-echec');

      if (testsEchecDiv && percentEchecDiv) {
        // Construire URL filtr√©e pour les tests √©chou√©s
        let echecUrl = `/admin/core/executiontest/?statut__exact=error`;
        if (projetId) echecUrl += `&configuration__projet=${projetId}`;

        // Chiffres cliquables
        testsEchecDiv.innerHTML = `<a href="${echecUrl}">${data.tests_en_echec}</a>`;
        // percentEchecDiv.textContent = `${data.percent_tests_echec}%`;
      }

      // Total tests cliquables
      const totalTestsDiv = document.getElementById('total-tests-value');
      if (totalTestsDiv) {
        let totalUrl = `/admin/core/executiontest/?`;
        if (projetId) totalUrl += `configuration__projet=${projetId}`;
        totalTestsDiv.innerHTML = `<a href="${totalUrl}">${data.total_tests}</a>`;
      }

      // Scripts non ex√©cut√©s (optionnel)
      const scriptsNonExecDiv = document.getElementById('scripts-non-executes-value');
      if (scriptsNonExecDiv) {
        scriptsNonExecDiv.textContent = data.scripts_non_executes;
      }

      const percentScriptsNonExecDiv = document.getElementById('percent-scripts-non-executes');
      if (percentScriptsNonExecDiv) {
        percentScriptsNonExecDiv.textContent = `${data.percent_scripts_non_executes}%`;
      }
    })
    .catch(error => {
      console.error("Erreur lors du fetch des KPIs scripts/tests :", error);
    });
});
</script>

{% endblock %}