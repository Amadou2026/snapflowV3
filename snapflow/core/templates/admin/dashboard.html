{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="{% static 'js/dashboard-charts.js' %}"></script>

<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/custom_admin.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-header">
    <h1 class="dashboard-title">📊 Monitoring des Tests</h1>

    <form method="get" id="dashboard-form" class="dashboard-form">
      <label for="projet">Tous les projets :</label>
      <select name="projet_id" id="projet" onchange="this.form.submit();">
        <option value="" {% if not selected_projet_id %}selected{% endif %}>-- Tous les projets --</option>
        {% for projet in projets %}
        <option value="{{ projet.id }}" {% if projet.id|stringformat:"s" == selected_projet_id %}selected{% endif %}>
          {{ projet.nom }}
        </option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- KPI Grid responsive -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="chart-header">
        <span class="chart-icon">🧩</span>
        <h3 class="chart-title">Répartition par projet</h3>
      </div>
      <div class="chart-container pie">
        <canvas id="projetChart"></canvas>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-icon primary">📈</div>
      </div>
      <div id="total-tests" class="kpi-value">{{ total_tests }}</div>
      <div class="kpi-label">Total des tests</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-icon success">🎯</div>
        <span id="status-indicator" class="status-indicator"></span>
      </div>
      <div id="kpi-taux-reussite" class="kpi-value">0%</div>
      <div class="kpi-label">Taux de réussite global</div>
    </div>

    <!-- Bloc Alertes -->
    <div class="kpi-card-modern">
      <div class="kpi-header-modern">
        <div class="kpi-icon-modern warning"></div>
        <div class="kpi-title">Les scipts non exécutités / échoués</div>
      </div>
      <div class="kpi-section">
        <div class="kpi-number">
          <strong id="scripts-non-executes-value">--</strong>
          <span class="kpi-percent" id="percent-scripts-non-executes">-- %</span>
          <span class="kpi-percent" id="percent-scripts-non-executes">%</span>
        </div>
        <div class="kpi-label">Scripts non exécutés</div>
      </div>
      <div class="kpi-divider"></div>
      <div class="kpi-section">
        <div class="kpi-number">
          <strong id="tests-en-echec-value">--</strong>
          <span class="kpi-percent" id="percent-tests-echec">--%</span>
          <span class="kpi-percent" >%</span>
        </div>
        <div class="kpi-label">Tests échoués</div>
      </div>
    </div>
  </div>

  <!-- Graphique évolution -->
  <div class="chart-card withfull mt-5">
    <div class="chart-header">
      <span class="chart-icon">⚖️</span>
      <h3 class="chart-title">Évolution des tests par jour</h3>
    </div>
    <div class="chart-container">
      <canvas id="sfChart"></canvas>
    </div>
  </div>

  <!-- Graphique projets avec erreurs -->
  <div class="chart-card margin-top-large">
    <div class="chart-header">
      <span class="chart-icon">⚠️</span>
      <h3 class="chart-title">Projet avec le plus et le moins d'erreurs</h3>
    </div>

    <div class="filters-container">
      <div class="filters-row">
        <div class="filter-group">
          <label for="periodeSelect">Filtrer par :</label>
          <select id="periodeSelect">
            <option value="jour">Dernier jour</option>
            <option value="semaine">Dernière semaine</option>
            <option value="mois" selected>Dernier mois</option>
            <option value="annee">Dernière année</option>
          </select>
        </div>
      </div>
      <div id="periodeIndicator" class="periode-indicator"></div>
    </div>

    <div class="chart-container" style="position: relative;">
      <canvas id="projetErreurChart" width="600" height="300"></canvas>
      <div id="chartLoader" class="chart-loader">
        <div class="spinner"></div>
        <p>Chargement...</p>
      </div>
    </div>
  </div>
</div>
 <!-- .dashboard-container -->

<!-- JS Data -->
<script>
  window.dashboardData = {
    labels: {{ labels | safe }},
  values: {{ values | safe }},
  sf_labels: {{ sf_labels | safe }},
  sf_success: {{ sf_success | safe }},
  sf_fail: {{ sf_fail | safe }},
  projet_labels: {{ projet_labels | safe }},
  projet_counts: {{ projet_counts | safe }},
  erreurs_labels: {{ erreurs_labels | safe }},
  erreurs_counts: {{ erreurs_counts | safe }}
  };
</script>

<!-- Script pour initialiser les graphiques + injecter les KPI scripts/tests -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // console.log("Document chargé");
    initCharts(window.dashboardData);

    fetch('/api/stats/scripts-tests/')
      .then(response => response.json())
      .then(data => {
        // console.log("Données récupérées :", data);

        document.getElementById('scripts-non-executes-value').textContent = data.scripts_non_executes;
        document.getElementById('percent-scripts-non-executes').textContent = data.percent_scripts_non_executes;

        document.getElementById('tests-en-echec-value').textContent = data.tests_en_echec;
        document.getElementById('percent-tests-echec').textContent = data.percent_tests_echec;
      })
      .catch(error => {
        console.error("Erreur lors du fetch des KPIs scripts/tests :", error);
      });
  });
</script>
{% endblock %}