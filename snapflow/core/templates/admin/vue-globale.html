{% extends "admin/base_site.html" %}
{% load static custom_filters %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'css/custom_admin.css' %}">
<link rel="stylesheet" href="{% static 'css/vue_globale.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <form method="get" id="periode-form" style="margin-bottom: 1em;">
            <label for="periode">Filtrer par p√©riode : </label>
            <select name="periode" id="periode" onchange="this.form.submit()">
                <option value="jour" {% if periode == 'jour' %}selected{% endif %}>Jour</option>
                <option value="semaine" {% if periode == 'semaine' %}selected{% endif %}>Semaine</option>
                <option value="mois" {% if periode == 'mois' %}selected{% endif %}>Mois</option>
                <option value="annee" {% if periode == 'annee' %}selected{% endif %}>Ann√©e</option>
            </select>
        </form>
    </div>

    <h3>Vue Globale des Tests</h3>

    <div class="kpi-section">
        <div class="kpi-card" title="Nombre total de tests ex√©cut√©s">
            <div class="kpi-icon primary">üìä</div>
            <div class="kpi-value">
                <a href="{% url 'admin:core_executiontest_changelist' %}" class="kpi-link" title="Voir tous les tests ex√©cut√©s">
                    {{ total_tests }}
                </a>
            </div>
            <div class="kpi-label">Total des tests ex√©cut√©s</div>
        </div>

        <div class="kpi-card" title="Nombre de tests non fonctionnels">
            <div class="kpi-icon error">‚ùå</div>
            <div class="kpi-value">
                <a href="{% url 'admin:core_executiontest_changelist' %}?statut__exact=error" class="kpi-link" title="Voir les tests non fonctionnels">
                    {{ non_fonctionnels }}
                </a>
            </div>
            <div class="kpi-label">Tests non concluants</div>
        </div>
    </div>

    <hr>

    <h3 class="espace_top">Projets affect√©s √† l'utilisateur </h3>
    <table class="admin-table" role="grid" aria-label="Liste des projets et statistiques des tests">
        <thead>
            <tr>
                <th scope="col">Projet</th>
                <th scope="col">Tests ex√©cut√©s</th>
                <th scope="col">Concluants ‚úÖ</th>
                <th scope="col">Non concluants ‚ùå</th>
            </tr>
        </thead>
        <tbody>
            {% for projet in projets_utilisateur %}
            {% with execution_tests_by_projet|get_item:projet.id as stats %}
            <tr>
                <td>{{ projet.nom }}</td>
                <td>
                    <a href="{% url 'admin:core_executiontest_changelist' %}?configuration__projet={{ projet.id }}" class="kpi-link" title="Voir tous les tests du projet {{ projet.nom }}">
                        {{ stats.total|default:0 }}
                    </a>
                </td>
                <td>
                    <a href="{% url 'admin:core_executiontest_changelist' %}?configuration__projet={{ projet.id }}&statut__exact=done">
                        {{ stats.success|default:0 }}
                    </a>
                </td>
                <td>
                    <a href="{% url 'admin:core_executiontest_changelist' %}?configuration__projet={{ projet.id }}&statut__exact=error">
                        {{ stats.fail|default:0 }}
                    </a>
                </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr>
                <td colspan="4" style="text-align:center; font-style: italic;">Aucun projet affect√©.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="chart-card withfull espace_top" aria-label="Graphique du taux d'erreur par script">
        <hr>
        <h3 class="chart-title">Taux d'erreur par script</h3>
        <div class="chart-container">
            <canvas id="erreursScriptChart" role="img" aria-label="Graphique en barres du nombre d'erreurs par script"></canvas>
        </div>
    </div>

    <br>

    <div class="chart-card withfull">
        <div class="chart-header">
            <span class="chart-icon">‚öñÔ∏è</span>
            <h3 class="chart-title">Tests non ex√©cut√©s et tests √©chou√©s</h3>
        </div>
        <div class="chart-container">
            <canvas id="testsNonExecuteChart" role="img" aria-label="Graphique en barres des tests non ex√©cut√©s et non concluants"></canvas>
        </div>
    </div>

 <script src="{% static 'js/dashboard-charts.js' %}"></script>
 <script src="{% static 'js/vue-globale-chart.js' %}"></script>
</div>
{% endblock %}
