{% extends "admin/base_site.html" %}
{% load static custom_filters %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'css/custom_admin.css' %}">
<link rel="stylesheet" href="{% static 'css/vue_globale.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- Filtres -->
    <div class="filter-section">
        <form method="get" id="periode-form" class="periode-form">
            <label for="periode">Filtrer par p√©riode :</label>
            <select name="periode" id="periode" onchange="this.form.submit()">
                <option value="jour" {% if periode == 'jour' %}selected{% endif %}>Jour</option>
                <option value="semaine" {% if periode == 'semaine' %}selected{% endif %}>Semaine</option>
                <option value="mois" {% if periode == 'mois' %}selected{% endif %}>Mois</option>
                <option value="annee" {% if periode == 'annee' %}selected{% endif %}>Ann√©e</option>
            </select>
        </form>
    </div>

    <h3>üìà Vue Globale des Tests</h3>

    <!-- KPIs -->
    <div class="kpi-section">
        <div class="kpi-card" title="Nombre total de tests ex√©cut√©s">
            <div class="kpi-icon primary"></div>
            <div class="kpi-value">
                <a href="{% url 'admin:core_executiontest_changelist' %}" class="kpi-link">
                    {{ total_tests }}
                </a>
            </div>
            <div class="kpi-label">Total des tests ex√©cut√©s</div>
        </div>

        <div class="kpi-card" title="Nombre de tests non fonctionnels">
            <div class="kpi-icon error"></div>
            <div class="kpi-value">
                <a href="{% url 'admin:core_executiontest_changelist' %}?statut__exact=error" class="kpi-link">
                    {{ non_fonctionnels }}
                </a>
            </div>
            <div class="kpi-label">Tests non concluants</div>
        </div>

        <!-- Scripts en attente -->
        <!-- <div class="kpi-card" title="Nombre de scripts Planifi√©">
            <div class="kpi-icon warning"></div>
            <div class="kpi-value">
                <a id="link-attente" href="{% url 'admin:core_executionresult_changelist' %}?statut__exact=pending"
                    class="kpi-link">
                    <span id="val-attente">{{ tests_script_en_attente|default:0 }}</span>
                </a>
            </div>
            <div class="kpi-label">
                {% if tests_script_en_attente and tests_script_en_attente > 0 %}
                Scripts Planifi√©
                {% else %}
                <span style="font-style: italic;">Aucun script planifi√©</span>
                {% endif %}
            </div>
        </div> -->

        <!-- Tests concluants -->
        <div class="kpi-card" title="Nombre de tests concluants">
            <div class="kpi-icon success"></div>
            <div class="kpi-value">
                <a href="{% url 'admin:core_executiontest_changelist' %}?statut__exact=done" class="kpi-link">
                    {{ tests_reussis }}
                </a>
            </div>
            <div class="kpi-label">
                {% if tests_reussis > 0 %}
                Tests concluants
                {% else %}
                <span style="font-style: italic;">Aucun test concluant</span>
                {% endif %}
            </div>
        </div>

        <!-- Tests non ex√©cut√©s -->
        <div class="kpi-card" title="Nombre de tests non ex√©cut√©s">
            <div class="kpi-icon nonexecute"></div>
            <div class="kpi-value">
                {% if non_executed > 0 %}
                <a href="{% url 'admin:core_executiontest_changelist' %}?statut__exact=non_executed" class="kpi-link">
                    {{ non_executed }}
                </a>
                {% else %}
                <span class="kpi-link">0</span>
                {% endif %}
            </div>
            <div class="kpi-label">
                {% if non_executed > 0 %}
                Tests non ex√©cut√©s
                {% else %}
                <span style="font-style: italic;">Aucun test non ex√©cut√© d√©tect√©</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Scripts planifi√©s -->
    <div class="chart-card espace_top">
        <h3>Prochains scripts planifi√©s (24h)</h3>
        <div id="scheduled-scripts" class="table-container">
            <p>Chargement‚Ä¶</p>
        </div>
    </div>

    <!-- Configurations en retard -->
    <div class="chart-card espace_top">
        <h3>Configurations en retard</h3>
        <div id="overdue-configurations" class="table-container">
            <p>Chargement‚Ä¶</p>
        </div>
    </div>

    <!-- Projets affect√©s -->
    <h3 class="espace_top">Projets affect√©s √† l'utilisateur</h3>
    <table class="admin-table" role="grid">
        <thead>
            <tr>
                <th>Projet</th>
                <th>Tests ex√©cut√©s</th>
                <th>Concluants ‚úÖ</th>
                <th>Non concluants ‚ùå</th>
            </tr>
        </thead>
        <tbody>
            {% for projet in projets_utilisateur %}
            {% with execution_tests_by_projet|get_item:projet.id as stats %}
            <tr>
                <td>{{ projet.nom }}</td>
                <td>
                    <a href="{% url 'admin:core_executiontest_changelist' %}?configuration__projet={{ projet.id }}"
                        class="kpi-link">
                        {{ stats.total|default:0 }}
                    </a>
                </td>
                <td>
                    <a
                        href="{% url 'admin:core_executiontest_changelist' %}?configuration__projet={{ projet.id }}&statut__exact=done">
                        {{ stats.success|default:0 }}
                    </a>
                </td>
                <td>
                    <a
                        href="{% url 'admin:core_executiontest_changelist' %}?configuration__projet={{ projet.id }}&statut__exact=error">
                        {{ stats.fail|default:0 }}
                    </a>
                </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr>
                <td colspan="4" style="text-align:center; font-style: italic;">Aucun projet affect√©.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Graphiques -->
    <div class="chart-card espace_top" aria-label="Graphique du taux d'erreur par script">
        <h3 class="chart-title">Taux de bugs par script</h3>
        <div class="chart-container">
            <canvas id="erreursScriptChart" role="img" aria-label="Graphique des erreurs par script"></canvas>
        </div>
    </div>

    <div class="chart-card espace_top">
        <div class="chart-header">
            <span class="chart-icon"></span>
            <h3 class="chart-title">Scripts concluants / non concluants</h3>
        </div>
        <div class="chart-container">
            <canvas id="testsconcluantnonconcluant" role="img"
                aria-label="Graphique en barres des scripts concluants et non concluants"></canvas>
        </div>
    </div>

</div>

<script src="{% static 'js/dashboard-charts.js' %}" defer></script>
<script src="{% static 'js/vue-globale-chart.js' %}" defer></script>
<script src="{% static 'js/vue-globale.js' %}" defer></script>
{% endblock %}
